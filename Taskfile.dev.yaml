version: "3"

vars:
  YQ: docker run --rm -v .:/boardsbe mikefarah/yq

tasks:
  env:
    desc: >-
      Start development environment
      - Envoy 
      - Postgress
    vars:
      DEV_ENVOY_DOCKER_IMAGE: envoyproxy/envoy:v1.28-latest
      APP_PORT:
        sh: "{{.YQ}} '.dev.app_port' /boardsbe/config/dev.yaml"
      ENVOY_PORT:
        sh: "{{.YQ}} '.dev.envoy_docker_port' /boardsbe/config/dev.yaml"
      GRPC_SERVER_PORT:
        sh: "{{.YQ}} '.grpc_server.port' /boardsbe/config/dev.yaml"
    cmds:
      - cp config/envoy.dev.example.yaml config/envoy.dev.yaml
      - "{{.YQ}} --inplace '.static_resources.listeners[0].address.socket_address.port_value = {{.ENVOY_PORT}}'  /boardsbe/config/envoy.dev.yaml"
      - "{{.YQ}} --inplace '.static_resources.clusters[0].load_assignment.endpoints[0].lb_endpoints[0].endpoint.address.socket_address.port_value = {{.GRPC_SERVER_PORT}}' /boardsbe/config/envoy.dev.yaml"
      - docker run --rm -d --name boardsbe.dev -v ./config/envoy.dev.yaml:/etc/envoy/envoy.yaml -p {{.APP_PORT}}:{{.ENVOY_PORT}} -e ENVOY_UID=$(id -u) {{.DEV_ENVOY_DOCKER_IMAGE}}

  stopenv:
    cmd: docker stop boardsbe.dev

  grpcui:
    vars:
      APP_PORT:
        sh: "{{.YQ}} '.dev.app_port' /boardsbe/config/dev.yaml"
    cmd: go run github.com/fullstorydev/grpcui/cmd/grpcui@latest -plaintext localhost:{{.APP_PORT}}
